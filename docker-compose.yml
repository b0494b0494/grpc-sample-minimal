version: '3.8'

services:
  server:
    build:
      context: .
      dockerfile: Dockerfile.server
    ports:
      - "${GRPC_SERVER_PORT}:${GRPC_SERVER_PORT}"
    networks:
      - grpc-network
    depends_on:
      - localstack
    environment:
      - AUTH_TOKEN=${AUTH_TOKEN}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME}
      - LOCALSTACK_ENDPOINT=${LOCALSTACK_ENDPOINT}
      - GRPC_SERVER_PORT=${GRPC_SERVER_PORT}

  client:
    build:
      context: .
      dockerfile: Dockerfile.client
    depends_on:
      - server
    networks:
      - grpc-network
    command: ["/app/client/client", "Docker"]
    environment:
      - AUTH_TOKEN=${AUTH_TOKEN}

  webapp:
    build:
      context: .
      dockerfile: Dockerfile.webapp
    ports:
      - "8080:8080"
    depends_on:
      - server
    networks:
      - grpc-network
    environment:
      - AUTH_TOKEN=${AUTH_TOKEN}

  localstack:
    image: localstack/localstack:latest
    ports:
      - "4566:4566"  # S3
      - "4510-4559:4510-4559" # Other services
    environment:
      - SERVICES=s3
      - DEFAULT_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
    networks:
      - grpc-network

networks:
  grpc-network:
    driver: bridge
