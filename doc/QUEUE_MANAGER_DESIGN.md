# ?????????????????

## ??

???????????????????????????S3?GCS?Azure?????????????????????
????????OCR???????????????????????????

## ?????

### ???????

```
???????????????
?   Server    ?
?  (service)  ?
???????????????
       ? EnqueueOCRTask
       ?
???????????????????????
?  QueueManager       ?
?  (in-process)       ?
?                     ?
?  ????????????????  ?
?  ? S3 Queue     ?  ?
?  ????????????????  ?
?  ????????????????  ?
?  ? GCS Queue    ?  ?
?  ????????????????  ?
?  ????????????????  ?
?  ? Azure Queue  ?  ?
?  ????????????????  ?
??????????????????????
       ? DequeueOCRTask
       ?
???????????????
? OCR Service ?
?  (workers)  ?
??????????????
```

### ??

1. **?????????**: ??????????????????????????
2. **???????**: `sync.RWMutex`???????????
3. **?????**: ????????????????????????????
4. **?????????**: ??????????????????

### ????

1. **????????** (`server/application/service.go`)
   - ????????????`documents/` ??? `images/` ???????
   - ????????????OCR?????????

2. **OCR????** (`server/ocr/main.go`)
   - ?????????????????????
   - ????????????OCR????????
   - ????????????????????????

## ?????????????????

### ????????????

1. **????????**: ????????????????????
2. **???**: ?????????????????????????
3. **??????**: ???????????????????
4. **???????????**: ???????????????????????

### ???????

#### 1. gRPC?????????

```
???????????????         gRPC          ????????????????????
?   Server    ? ????????????????????? ? Queue Manager    ?
?  (service)  ?   EnqueueOCRTask      ?    Service       ?
???????????????                        ?  (Container)     ?
                                       ?                  ?
???????????????         gRPC          ?  ??????????????  ?
? OCR Service ? ????????????????????? ?  S3 Queue    ?  ?
?  (workers)  ?   DequeueOCRTask       ?  ??????????????  ?
???????????????                        ?  ??????????????  ?
                                       ?  ? GCS Queue  ?  ?
                                       ?  ??????????????  ?
                                       ?  ??????????????  ?
                                       ?  ?Azure Queue ?  ?
                                       ?  ??????????????  ?
                                       ????????????????????
```

#### 2. ????

1. **proto???????**
   - `greeter.proto`?`QueueService`???
   - `EnqueueOCRTaskRequest`, `DequeueOCRTaskRequest`??????????

2. **gRPC???????**
   - `server/queue/main.go`???
   - `QueueManagerInterface`?????gRPC?????

3. **gRPC?????????**
   - `domain/queue_manager_client.go`???
   - ????????????????????????
   - `QueueManagerInterface`???

4. **???????**
   - ?????`QUEUE_MANAGER_MODE`???
   - `in-process` ??? `remote` ???
   - ??????`in-process`??????????

5. **Docker Compose???**
   - `queue-manager`???????
   - ??????????

#### 3. ??????????????

???????`QueueManagerInterface`????????
????????????????????

```go
// ??: in-process
queueManager := domain.GetQueueManager()

// ??: remote (gRPC)
queueManager := domain.NewRemoteQueueManager(endpoint)
```

### ????

1. **Phase 1 (??)**: in-process??
2. **Phase 2**: gRPC?????? + ????????
3. **Phase 3**: ?????????
4. **Phase 4**: ?????????????

### ????

- ??????????????
- ?????????????????
- ???????????????????????????????
- ????????????AUTH_TOKEN????

## ????

### ???????????????

```go
queueManager := domain.GetQueueManager()
err := queueManager.EnqueueOCRTask(ctx, filename, provider)
```

### ?????OCR?????

```go
queueManager := domain.GetQueueManager()
task, err := queueManager.DequeueOCRTask(ctx, storageProvider)
```

## ???????????

### ?????????

1. ???????????????: `queueManager.IsEnabled()`
2. ??????????????????
3. ??????????????????

### ??????????

1. OCR??????????????
2. ????????????????????????
3. ??????????????????????????
